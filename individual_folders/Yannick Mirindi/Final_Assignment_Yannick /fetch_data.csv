import requests
import json
import datetime
import csv

# Function to fetch data from OpenWeatherMap API
def fetch_data_openweathermap(api_url, latitude, longitude, api_key):
    # Set the date for which you want the data (e.g., 7 days ago)
    date = datetime.datetime.now() - datetime.timedelta(days=7)
    timestamp = int(date.timestamp())
    
    params = {
        "lat": latitude,
        "lon": longitude,
        "dt": timestamp,
        "appid": api_key
    }
    
    response = requests.get(api_url, params=params)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"Error: Unable to fetch data from OpenWeatherMap (Status code: {response.status_code})")
        return None

# Function to save data to a CSV file
def save_data_to_csv(data, filename):
    # Extract the relevant information from the data
    # This example assumes the data contains hourly temperature data
    hourly_data = data.get('hourly', [])
    
    # Define the CSV file header
    header = ['time', 'temperature', 'humidity', 'pressure', 'wind_speed', 'weather_description']
    
    # Open the CSV file for writing
    with open(filename, mode='w', newline='') as file:
        writer = csv.writer(file)
        
        # Write the header to the CSV file
        writer.writerow(header)
        
        # Write the data to the CSV file
        for hour in hourly_data:
            time = datetime.datetime.fromtimestamp(hour['dt']).strftime('%Y-%m-%d %H:%M:%S')
            temperature = hour['temp']
            humidity = hour['humidity']
            pressure = hour['pressure']
            wind_speed = hour['wind_speed']
            weather_description = hour['weather'][0]['description'] if 'weather' in hour and len(hour['weather']) > 0 else 'N/A'
            writer.writerow([time, temperature, humidity, pressure, wind_speed, weather_description])
        print(f"Data successfully saved to {filename}")

# Main function to orchestrate data fetching and saving
def main():
    # Define OpenWeatherMap API details
    openweathermap_api_url = "http://api.openweathermap.org/data/2.5/onecall/timemachine"
    api_key = "ef7da6e160c7e355073d9ececc7a5a2c"  
    latitude = "d24e712ca4474c57758d4f3aead5f197"
    longitude = "ed860f76503f457deea1b056e28dbdb9" 

    # Fetch data from OpenWeatherMap
    openweathermap_data = fetch_data_openweathermap(openweathermap_api_url, latitude, longitude, api_key)
    
    # Save OpenWeatherMap data to a CSV file if fetched successfully
    if openweathermap_data:
        save_data_to_csv(openweathermap_data, 'data/raw_data/urban_heat_islands_openweathermap.csv')

# Run the main function
if __name__ == "__main__":
    main()


